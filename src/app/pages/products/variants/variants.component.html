<p-toolbar class="mb-6">
    <ng-template pTemplate="start">
        <p-button
            label="Gestionar Variantes"
            icon="pi pi-clone"
            severity="secondary"
            (onClick)="openProductSelection()" />
    </ng-template>
    <ng-template pTemplate="end">
        <p-button
            label="Recargar"
            icon="pi pi-refresh"
            outlined
            severity="secondary"
            (onClick)="loadProductsWithVariants()" />
    </ng-template>
</p-toolbar>

<!-- Tabla de productos con variantes -->
<p-table
    [value]="productsWithVariants()"
    [loading]="loading()"
    dataKey="itemCode"
    styleClass="p-datatable-striped">
    <ng-template pTemplate="caption">
        <div class="flex items-center justify-between">
            <h5 class="m-0">Productos con Variantes</h5>
            <p-iconfield>
                <p-inputicon styleClass="pi pi-search" />
                <input pInputText type="text" placeholder="Buscar producto..." />
            </p-iconfield>
        </div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <th style="width: 12rem">Imagen</th>
            <th>Producto</th>
            <th style="width: 12rem">Precio Base</th>
            <th style="width: 15rem">Estado</th>
            <th style="width: 12rem">Acciones</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-product>
        <tr>
            <td>
                <div class="flex justify-center">
                    <img *ngIf="product.imageUrl"
                         [src]="product.imageUrl"
                         [alt]="product.itemName"
                         class="rounded border shadow-sm"
                         style="width: 64px; height: 64px; object-fit: cover;" />
                    <div *ngIf="!product.imageUrl"
                         class="w-16 h-16 bg-surface-100 dark:bg-surface-700 rounded border flex items-center justify-center">
                        <i class="pi pi-image text-muted-color text-xl"></i>
                    </div>
                </div>
            </td>
            <td>
                <div class="flex flex-col">
                    <span class="font-semibold text-lg">{{ product.itemName }}</span>
                    <small class="text-muted-color">{{ product.itemCode }}</small>
                </div>
            </td>
            <td>
                <span class="font-bold text-primary text-lg">{{ formatPrice(product.price) }}</span>
            </td>
            <td>
                <div class="flex flex-col gap-1">
                    <p-tag value="Con Variantes" severity="info" icon="pi pi-clone" />
                </div>
            </td>
            <td>
                <p-button
                    icon="pi pi-cog"
                    label="Gestionar"
                    [outlined]="true"
                    size="small"
                    (click)="selectProduct(product)"
                    pTooltip="Gestionar variantes" />
            </td>
        </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="5" class="text-center py-8">
                <i class="pi pi-clone text-6xl text-muted-color mb-4 block"></i>
                <h4 class="text-2xl mb-2">No hay productos con variantes</h4>
                <p class="text-muted-color">Los productos marcados con "Tiene Variantes" aparecerán aquí</p>
            </td>
        </tr>
    </ng-template>
</p-table>

<!-- Diálogo de selección de producto -->
<p-dialog
    [(visible)]="productSelectionDialog"
    [style]="{ width: '80vw', maxWidth: '900px' }"
    header="Seleccionar Producto para Gestionar Variantes"
    [modal]="true"
    (onHide)="hideProductSelectionDialog()">

    <div *ngIf="productsWithVariants().length > 0">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
            <div *ngFor="let product of productsWithVariants()"
                 class="border border-surface-200 dark:border-surface-700 rounded-lg p-4 hover:bg-surface-50 dark:hover:bg-surface-800 cursor-pointer transition-colors"
                 (click)="selectProduct(product)">
                <div class="flex items-start gap-3">
                    <div class="w-12 h-12 bg-surface-100 dark:bg-surface-700 rounded flex items-center justify-center">
                        <img *ngIf="product.imageUrl"
                             [src]="product.imageUrl"
                             [alt]="product.itemName"
                             class="w-full h-full object-cover rounded" />
                        <i *ngIf="!product.imageUrl" class="pi pi-clone text-muted-color"></i>
                    </div>
                    <div class="flex-1">
                        <h6 class="font-semibold mb-1">{{ product.itemName }}</h6>
                        <p class="text-sm text-muted-color mb-2">{{ product.itemCode }}</p>
                        <div class="flex items-center gap-2">
                            <p-tag value="Con Variantes" severity="info" styleClass="text-xs" icon="pi pi-clone" />
                            <span class="font-medium text-primary">{{ formatPrice(product.price) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="productsWithVariants().length === 0" class="text-center py-8">
        <i class="pi pi-clone text-4xl text-muted-color mb-4 block"></i>
        <h6 class="text-lg mb-2">No hay productos con variantes</h6>
        <p class="text-muted-color">Primero debe marcar productos con "Tiene Variantes" en el módulo de productos</p>
    </div>
</p-dialog>

<!-- Diálogo de gestión de variantes -->
<p-dialog
    [(visible)]="variantDialog"
    [style]="{ width: '95vw', maxWidth: '1400px' }"
    [header]="'Gestionar Variantes - ' + (selectedProduct()?.itemName || '')"
    [modal]="true"
    (onHide)="hideVariantDialog()"
    [maximizable]="true">

    <div *ngIf="selectedProduct()">
        <!-- Header con info del producto -->
        <div class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg mb-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-surface-100 dark:bg-surface-700 rounded-lg flex items-center justify-center">
                    <img *ngIf="selectedProduct()!.imageUrl"
                         [src]="selectedProduct()!.imageUrl"
                         [alt]="selectedProduct()!.itemName"
                         class="w-full h-full object-cover rounded-lg" />
                    <i *ngIf="!selectedProduct()!.imageUrl" class="pi pi-clone text-muted-color text-2xl"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold mb-1">{{ selectedProduct()!.itemName }}</h4>
                    <p class="text-muted-color text-sm">{{ selectedProduct()!.itemCode }}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-muted-color">Precio Base</p>
                    <p class="text-2xl font-bold text-primary">{{ formatPrice(selectedProduct()!.price) }}</p>
                </div>
            </div>
        </div>

        <!-- Botón agregar variante -->
        <div class="mb-4">
            <p-button
                label="➕ Agregar Variante"
                icon="pi pi-plus"
                severity="secondary"
                (onClick)="addVariantSlot()" />
        </div>

        <!-- Nuevas variantes (slots) -->
        <div class="space-y-3 mb-6" *ngIf="variantSlots().length > 0">
            <h6 class="font-semibold mb-4 text-primary">➕ Nuevas Variantes</h6>
            <div *ngFor="let slot of variantSlots(); let i = index"
                 class="p-4 border-l-4 border-l-primary-500 bg-surface-0 dark:bg-surface-900 rounded-r shadow-sm">

                <!-- Header del slot -->
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="bg-primary text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold">
                            {{ i + 1 }}
                        </span>
                        <span class="font-medium">Nueva Variante {{ i + 1 }}</span>
                    </div>
                    <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        [rounded]="true"
                        [outlined]="true"
                        size="small"
                        (click)="removeVariantSlot(i)"
                        pTooltip="Eliminar variante" />
                </div>

                <!-- Campos de la variante -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div>
                        <label class="block font-medium mb-2">Nombre de la Variante *</label>
                        <input
                            type="text"
                            pInputText
                            [(ngModel)]="slot.variantName"
                            placeholder="Ej: Coca Cola 500ml"
                            fluid />
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Marca *</label>
                        <input
                            type="text"
                            pInputText
                            [(ngModel)]="slot.brandName"
                            placeholder="Ej: Coca Cola"
                            fluid />
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Tamaño</label>
                        <p-dropdown
                            [(ngModel)]="slot.sizeCode"
                            [options]="availableSizes()"
                            optionLabel="sizeName"
                            optionValue="sizeCode"
                            placeholder="Seleccione tamaño"
                            [showClear]="true"
                            fluid>
                            <ng-template let-size pTemplate="item">
                                <div class="flex items-center gap-2">
                                    <i class="pi pi-arrows-v text-primary"></i>
                                    <div>
                                        <div class="font-semibold">{{ size.sizeName }}</div>
                                        <small class="text-muted-color">{{ size.sizeCode }}</small>
                                    </div>
                                </div>
                            </ng-template>
                        </p-dropdown>
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Ajuste de Precio *</label>
                        <p-inputnumber
                            [(ngModel)]="slot.priceAdjustment"
                            mode="currency"
                            currency="USD"
                            [showButtons]="true"
                            fluid />
                        <small class="text-muted-color">Positivo=más caro, Negativo=más barato</small>
                    </div>
                    <div class="flex flex-col justify-end">
                        <label class="block font-medium mb-2">Disponible</label>
                        <div class="flex items-center gap-2 h-10">
                            <p-checkbox
                                [(ngModel)]="slot.available"
                                [binary]="true"
                                [trueValue]="'Y'"
                                [falseValue]="'N'"
                                inputId="available-{{i}}" />
                            <label [for]="'available-' + i" class="text-sm">Sí</label>
                        </div>
                    </div>
                </div>

                <!-- Preview del precio final -->
                <div *ngIf="slot.variantName" class="mt-4 p-3 bg-surface-50 dark:bg-surface-800 rounded">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">{{ slot.variantName }}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <small class="text-muted-color">{{ slot.brandName }}</small>
                                <span *ngIf="slot.sizeCode" class="text-muted-color">•</span>
                                <p-tag *ngIf="slot.sizeCode" [value]="getSizeName(slot.sizeCode)" severity="secondary" styleClass="text-xs" icon="pi pi-arrows-v" />
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <p class="text-sm text-muted-color">Precio Base</p>
                                <p class="font-medium">{{ formatPrice(selectedProduct()!.price) }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-muted-color">Ajuste</p>
                                <p class="font-medium" [ngClass]="{
                                    'text-success': slot.priceAdjustment < 0,
                                    'text-danger': slot.priceAdjustment > 0
                                }">
                                    {{ formatPriceAdjustment(slot.priceAdjustment) }}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-muted-color">Precio Final</p>
                                <p class="text-lg font-bold text-primary">
                                    {{ formatPrice(selectedProduct()!.price + slot.priceAdjustment) }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Variantes existentes -->
        <div *ngIf="variants().length > 0">
            <h6 class="font-semibold mb-4 text-success">📋 Variantes Existentes ({{ variants().length }})</h6>
            <div class="space-y-3">
                <div *ngFor="let variant of variants(); let i = index"
                     class="p-4 border-l-4 border-l-success-500 bg-success-50 dark:bg-success-900/20 rounded-r shadow-sm">

                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="bg-success text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold">
                                {{ i + 1 }}
                            </span>
                            <span class="font-medium text-success-800 dark:text-success-200">{{ variant.variantName }}</span>
                            <p-tag [value]="variant.brandName" severity="secondary" styleClass="text-xs" />
                            <p-tag *ngIf="variant.sizeCode" [value]="getSizeName(variant.sizeCode)" severity="info" styleClass="text-xs" icon="pi pi-arrows-v" />
                        </div>
                        <p-button
                            icon="pi pi-trash"
                            severity="danger"
                            [rounded]="true"
                            [outlined]="true"
                            size="small"
                            (click)="deleteVariant(variant)"
                            pTooltip="Eliminar variante" />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-muted-color">Precio Base</p>
                            <p class="font-bold text-lg">{{ formatPrice(variant.basePrice) }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-muted-color">Ajuste</p>
                            <p class="font-bold text-lg" [ngClass]="{
                                'text-success': variant.priceAdjustment < 0,
                                'text-danger': variant.priceAdjustment > 0
                            }">
                                {{ formatPriceAdjustment(variant.priceAdjustment) }}
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-muted-color">Precio Final</p>
                            <p class="font-bold text-lg text-primary">{{ formatPrice(variant.finalPrice) }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-muted-color">Estado</p>
                            <p-tag
                                [value]="getAvailableLabel(variant.available)"
                                [severity]="getAvailableSeverity(variant.available)" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estado vacío -->
        <div *ngIf="variants().length === 0 && variantSlots().length === 0" class="text-center text-muted-color py-12">
            <i class="pi pi-clone text-6xl mb-4 block"></i>
            <h6 class="text-xl mb-2">Sin Variantes Configuradas</h6>
            <p class="mb-4">Este producto no tiene variantes aún</p>
            <p-button
                label="Agregar Primera Variante"
                icon="pi pi-plus"
                (onClick)="addVariantSlot()" />
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-between items-center w-full">
            <div class="flex items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <i class="pi pi-clone text-primary"></i>
                    <span class="font-medium">{{ selectedProduct()?.itemName }}</span>
                </div>
                <div class="flex items-center gap-2 text-muted-color">
                    <i class="pi pi-plus"></i>
                    <span>{{ variantSlots().length }} nueva(s)</span>
                </div>
                <div class="flex items-center gap-2 text-muted-color">
                    <i class="pi pi-list"></i>
                    <span>{{ variants().length }} guardada(s)</span>
                </div>
            </div>
            <div class="flex gap-2">
                <p-button
                    label="Cancelar"
                    icon="pi pi-times"
                    outlined
                    (click)="hideVariantDialog()" />
                <p-button
                    label="💾 Guardar Variantes"
                    icon="pi pi-check"
                    [loading]="loading()"
                    [disabled]="variantSlots().length === 0 || !hasValidSlots()"
                    (click)="saveAllVariants()" />
            </div>
        </div>
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" acceptLabel="Sí" rejectLabel="No" />
<p-toast />
